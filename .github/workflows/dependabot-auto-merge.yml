name: Dependabot Auto-Merge

on:
  pull_request_target:
    types: [opened, reopened, synchronize]
  workflow_run:
    workflows: ["Quality Gates", "CI"]
    types: [completed]

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run on Dependabot PRs
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Wait for status checks
        # Wait a bit to ensure all checks have started
        run: sleep 30

      - name: Check PR status
        id: pr-status
        run: |
          # Get PR details
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Check if PR has any required checks pending or failing
          PR_STATUS=$(gh pr checks "$PR_NUMBER" --json state --jq '.[].state' | sort -u)

          echo "Check statuses: $PR_STATUS"

          # If any check is not SUCCESS, don't merge
          if echo "$PR_STATUS" | grep -v "SUCCESS" | grep -q .; then
            echo "merge=false" >> "$GITHUB_OUTPUT"
            echo "Checks are not all passing yet"
          else
            echo "merge=true" >> "$GITHUB_OUTPUT"
            echo "All checks passed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for minor and patch updates
        # Only auto-merge if all checks pass and it's a minor/patch update
        if: |
          steps.pr-status.outputs.merge == 'true' &&
          (steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
           steps.metadata.outputs.update-type == 'version-update:semver-patch')
        run: |
          gh pr merge --auto --squash "$PR_NUMBER"
          echo "✅ Auto-merge enabled for PR #$PR_NUMBER"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on successful auto-merge setup
        if: |
          steps.pr-status.outputs.merge == 'true' &&
          (steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
           steps.metadata.outputs.update-type == 'version-update:semver-patch')
        run: |
          gh pr comment "$PR_NUMBER" --body "✅ Auto-merge enabled. This PR will be automatically merged when all checks pass."
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
