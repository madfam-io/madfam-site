# MADFAM Site - Corporate Website & Documentation
# Deploy via Enclii

apiVersion: enclii.dev/v1
kind: Service
metadata:
  name: madfam-site
  project: madfam-platform
  description: MADFAM corporate website, documentation, and product hub

spec:
  build:
    type: dockerfile
    dockerfile: Dockerfile
    context: .
    source:
      git:
        repository: https://github.com/madfam-io/madfam-site
        branch: main
        autoDeploy: true

  runtime:
    port: 3000
    replicas: 2
    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"

    healthCheck: /api/health
    readinessProbe:
      path: /api/health
      initialDelaySeconds: 10
      periodSeconds: 5
    livenessProbe:
      path: /api/health
      initialDelaySeconds: 20
      periodSeconds: 10

  env:
    - name: PORT
      value: "3000"
    - name: NODE_ENV
      value: production

    # MADFAM Analytics (self-dogfooding)
    - name: NEXT_PUBLIC_ANALYTICS_URL
      value: https://analytics.madfam.io
    - name: NEXT_PUBLIC_ANALYTICS_SITE_ID
      value: madfam-site

    # Coforma Feedback
    - name: NEXT_PUBLIC_COFORMA_URL
      value: https://coforma.madfam.io
    - name: NEXT_PUBLIC_COFORMA_PRODUCT_ID
      value: madfam-site

  domains:
    - domain: madfam.io
      tls: true
      tlsIssuer: cloudflare
    - domain: www.madfam.io
      tls: true
      tlsIssuer: cloudflare
      redirect: madfam.io
    - domain: docs.madfam.io
      tls: true
      tlsIssuer: cloudflare

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 6
    targetCPUUtilizationPercentage: 70

  slo:
    availability: 99.95
    latencyP95: 100
    errorRate: 0.1

  # CDN caching for static assets
  cdn:
    enabled: true
    cacheStaticAssets: true
    cacheMaxAge: 86400
