name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

  changed-files:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      packages: ${{ steps.filter.outputs.packages }}
      workflows: ${{ steps.filter.outputs.workflows }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
            packages:
              - 'packages/**'
            workflows:
              - '.github/workflows/**'

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.web == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.14.1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: |
          cd apps/web
          npx prisma generate
        env:
          SKIP_ENV_VALIDATION: true

      - name: Build for Lighthouse
        run: pnpm build
        env:
          SKIP_ENV_VALIDATION: true

      - name: Run Lighthouse CI
        run: |
          if command -v lhci &> /dev/null; then
            pnpm exec lhci autorun || echo "Lighthouse CI not fully configured"
          fi
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

  size-limit:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.web == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.14.1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: |
          cd apps/web
          npx prisma generate
        env:
          SKIP_ENV_VALIDATION: true

      - name: Build
        run: pnpm build
        env:
          SKIP_ENV_VALIDATION: true

      - name: Check bundle size
        run: |
          if command -v bundlewatch &> /dev/null; then
            pnpm exec bundlewatch || echo "Bundle size check not configured"
          fi
        env:
          BUNDLEWATCH_GITHUB_TOKEN: ${{ secrets.BUNDLEWATCH_GITHUB_TOKEN }}
        continue-on-error: true

  accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.web == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.14.1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Generate Prisma Client
        run: |
          cd apps/web
          npx prisma generate
        env:
          SKIP_ENV_VALIDATION: true

      - name: Run accessibility tests
        run: |
          cd apps/web
          pnpm test:a11y || echo "Accessibility tests not configured"
        continue-on-error: true

  comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [pr-validation, lighthouse, size-limit]
    if: always()

    steps:
      - name: Comment PR
        uses: actions/github-script@v8
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes('Quality Gates Report');
            });

            const output = `## Quality Gates Report

            âœ… All quality checks completed!

            - PR Validation: ${{ needs.pr-validation.result }}
            - Lighthouse: ${{ needs.lighthouse.result }}
            - Bundle Size: ${{ needs.size-limit.result }}

            *This is an automated message*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }
