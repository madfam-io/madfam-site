version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_ENV=local
      - NEXT_PUBLIC_API_URL=http://localhost:3000
      # MADFAM ecosystem connections
      - JANUA_API_URL=http://janua-api:8001
      - FORGESIGHT_API_URL=http://forgesight-api:8100
      - COTIZA_API_URL=http://cotiza-api:8200
      # Janua Auth Integration
      - JANUA_ENABLED=true
      - JANUA_JWT_SECRET=dev-shared-janua-secret-32chars!!
      - NEXTAUTH_SECRET=dev-nextauth-secret-change-in-production
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - madfam-shared-network
    restart: unless-stopped

  # Development service
  web-dev:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    ports:
      - '3001:3090'
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:3001
      # MADFAM ecosystem connections
      - JANUA_API_URL=http://janua-api:8001
      - FORGESIGHT_API_URL=http://forgesight-api:8100
      - COTIZA_API_URL=http://cotiza-api:8200
      # Janua Auth Integration
      - JANUA_ENABLED=true
      - JANUA_JWT_SECRET=dev-shared-janua-secret-32chars!!
      - NEXTAUTH_SECRET=dev-nextauth-secret-change-in-production
    networks:
      - madfam-shared-network
    restart: unless-stopped

networks:
  madfam-shared-network:
    external: true
